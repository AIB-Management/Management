<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.gdaib.mapper.FileExtMapper">
    <resultMap id="FileCustom" type="com.gdaib.pojo.FileCustom">
        <id column="id" property="file.id" jdbcType="INTEGER"/>
        <id column="uid" property="file.uid" jdbcType="VARCHAR"/>
        <result column="accUid" property="file.accuid" jdbcType="VARCHAR"/>
        <result column="navUid" property="file.navuid" jdbcType="VARCHAR"/>
        <result column="upTime" property="file.uptime" jdbcType="TIMESTAMP"/>
        <result column="title" property="file.title" jdbcType="VARCHAR"/>
        <result column="url" property="file.url" jdbcType="VARCHAR"/>
        <result column="filePath" property="file.filepath" jdbcType="VARCHAR"/>
        <result column="author" property="author" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="where_File_Select_vo">
        <if test="id!=null">
            AND t_file.id=#{id}
        </if>
        <if test="uid!=null">
            AND t_file.uid=#{uid}
        </if>
        <if test="accuid!=null">
            AND t_file.accuid=#{accuid}
        </if>
        <if test="navuid!=null">
            AND t_file.navuid=#{navuid}
        </if>
        <if test="uptime!=null">
            AND t_file.uptime=#{uptime}
        </if>
        <if test="title!=null">
            AND t_file.title=#{title}
        </if>
        <if test="url!=null">
            AND t_file.url=#{url}
        </if>
        <if test="filepath!=null">
            AND t_file.filepath=#{filepath}
        </if>
    </sql>

    <delete id="deleteFile" parameterType="com.gdaib.pojo.FileSelectVo">
        <if test="uid!=null">
            <if test="accuid!=null">
                DELETE FROM
                `t_file`
                <where>
                    <include refid="where_File_Select_vo"></include>
                </where>
            </if>
        </if>
    </delete>

    <select id="selectFile" parameterType="com.gdaib.pojo.FileSelectVo" resultMap="FileCustom">
        SELECT
        t_file.uid,
        t_file.filePath,
        t_file.url,
        t_file.title,
        t_file.upTime,
        t_file.navUid,
        t_file.accUid,
        t_file.id,
        t_account.`name` AS author
        FROM
        t_account
        INNER JOIN t_file ON t_file.accUid = t_account.uid
        <where>
            <include refid="where_File_Select_vo"></include>
        </where>
    </select>

    <update id="updateFile" parameterType="com.gdaib.pojo.FileSelectVo">
        <if test="uid!=null">
            UPDATE `t_file`
            <set>
                <if test="navuid!=null">
                    navuid=#{navuid},
                </if>
                <if test="uptime!=null">
                    uptime=#{uptime},
                </if>
                <if test="title!=null">
                    title=#{title},
                </if>
                <if test="url!=null">
                    url=#{url},
                </if>
                <if test="filepath!=null">
                    filepath=#{filepath},
                </if>
            </set>
            WHERE uid=#{uid}
        </if>
    </update>

    <resultMap id="fileAndFileItem" type="com.gdaib.pojo.FileCustom">
        <id column="uid" property="uid"></id>
        <result column="title" property="title"></result>
        <result column="upTime" property="uptime"></result>
        <result column="filePath" property="filepath"></result>
        <result column="author" property="author"></result>

        <collection property="fileItems" ofType="com.gdaib.pojo.FileItemCustom">
            <id column="itemUid" property="uid"></id>
            <result column="filename" property="filename"></result>
            <result column="showing" property="showing"></result>
            <result column="prefix" property="prefix"></result>
            <result column="position" property="position"></result>
        </collection>

    </resultMap>

    <select id="selectFileAndFileItem" parameterType="com.gdaib.pojo.FileSelectVo" resultMap="fileAndFileItem">

        SELECT
            t_file.title,
            t_file.upTime,
            t_file.filePath,
            t_file.uid,
            t_file_item.filename,
            t_file_item.showing,
            t_file_item.prefix,
            t_file_item.uid AS itemUid,
            t_account.`name` AS author,
            t_file_item.position
            FROM
            t_file
            INNER JOIN t_file_item ON t_file_item.fileUid = t_file.uid
            INNER JOIN t_account ON t_file.accUid = t_account.uid
            WHERE
            t_file.uid = #{uid}
            ORDER BY
            t_file_item.position ASC

    </select>

    <select id="getCountFile" parameterType="com.gdaib.pojo.FileSelectVo" resultType="com.gdaib.pojo.FileCustom">
        SELECT COUNT(id) count FROM `t_file` WHERE navUid=#{navuid} LIMIT 0, 1000
    </select>

</mapper>